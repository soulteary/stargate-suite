# Stargate 独立 compose - 仅 Forward Auth 与示例受保护服务
#
# 依赖：Herald、Warden 已用独立 compose 启动，且与 Stargate 同属 the-gate-network。
# 通过容器名访问：the-gate-herald:8082、the-gate-warden:8081。
#
# 使用前确保：
#   1. docker network create the-gate-network
#   2. docker network create traefik
#   3. Herald 已启动：docker compose -f compose/traefik-herald/docker-compose.yml up -d
#   4. Warden 已启动：docker compose -f compose/traefik-warden/docker-compose.yml up -d
#
# 启动（在 stargate-suite 根目录）：
#   docker compose -f compose/traefik-stargate/docker-compose.yml up -d
#
# 停止：docker compose -f compose/traefik-stargate/docker-compose.yml down

services:
  stargate:
    image: ${STARGATE_IMAGE:-ghcr.io/soulteary/stargate:v0.7.1}
    container_name: the-gate-stargate
    ports: []
    environment:
      - AUTH_HOST=${AUTH_HOST:-auth.test.localhost}
      - PASSWORDS=${PASSWORDS:-plaintext:test1234|test1337}
      - LANGUAGE=${LANGUAGE:-zh}
      - WARDEN_URL=http://the-gate-warden:8081
      - WARDEN_ENABLED=${WARDEN_ENABLED:-true}
      - WARDEN_API_KEY=${WARDEN_API_KEY:-test-warden-api-key}
      - WARDEN_CACHE_TTL=300
      - HERALD_URL=http://the-gate-herald:8082
      - HERALD_ENABLED=${HERALD_ENABLED:-true}
      - HERALD_API_KEY=${HERALD_API_KEY:-test-herald-api-key}
      - HERALD_HMAC_SECRET=${HERALD_HMAC_SECRET:-test-hmac-secret}
      - SESSION_STORAGE_ENABLED=${SESSION_STORAGE_ENABLED:-false}
      - DEBUG=false
    networks:
      - the-gate-network
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-http.entrypoints=http"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-http.middlewares=redir-https"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-http.rule=Host(`${STARGATE_DOMAIN:-auth.test.localhost}`) || PathPrefix(`/_session_exchange`)"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-http.service=noop@internal"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-https.entrypoints=https"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-https.tls=true"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-https.middlewares=gzip"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-https.rule=Host(`${STARGATE_DOMAIN:-auth.test.localhost}`) || PathPrefix(`/_session_exchange`)"
      - "traefik.http.routers.${STARGATE_PREFIX:-stargate}-https.service=${STARGATE_PREFIX:-stargate}-backend"
      - "traefik.http.services.${STARGATE_PREFIX:-stargate}-backend.loadbalancer.server.scheme=http"
      - "traefik.http.services.${STARGATE_PREFIX:-stargate}-backend.loadbalancer.server.port=80"
      - "traefik.http.middlewares.stargate-auth.forwardauth.address=http://the-gate-stargate/_auth"
      - "traefik.http.middlewares.stargate-auth.forwardauth.authResponseHeaders=${USER_HEADER_NAME:-X-Forwarded-User}"
      - "traefik.http.middlewares.stargate-auth.forwardauth.authResponseHeadersRegex=X-Forwarded-.*"
      - "traefik.http.middlewares.stargate-auth.forwardauth.trustForwardHeader=true"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  protected-service:
    image: ${PROTECTED_IMAGE:-ghcr.io/traefik/whoami:v1.11}
    container_name: the-gate-whoami
    restart: unless-stopped
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-http.entrypoints=http"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-http.middlewares=redir-https"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-http.rule=Host(`${PROTECTED_DOMAIN:-whoami.test.localhost}`)"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-http.service=noop@internal"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-https.entrypoints=https"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-https.tls=true"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-https.middlewares=gzip,stargate-auth"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-https.rule=Host(`${PROTECTED_DOMAIN:-whoami.test.localhost}`)"
      - "traefik.http.routers.${PROTECTED_PREFIX:-protected}-https.service=${PROTECTED_PREFIX:-protected}-backend"
      - "traefik.http.services.${PROTECTED_PREFIX:-protected}-backend.loadbalancer.server.scheme=http"
      - "traefik.http.services.${PROTECTED_PREFIX:-protected}-backend.loadbalancer.server.port=80"

networks:
  the-gate-network:
    external: true
  traefik:
    external: true
